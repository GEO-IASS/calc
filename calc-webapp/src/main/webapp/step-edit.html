<!-- ==== Html here === -->
<div class="page-section" id="step-edit-page">


	<!--  Header button bar  -->
	<div class="row no-margin-no-padding header-button-group">
		<div class="col-md-2 col-md-offset-4 no-padding">
			<button class="btn blue-btn" name="show-edit-btn" >Edit</button>
		</div>
		<div class="col-md-2 no-padding">
			<button class="btn blue-btn" name="show-exec-btn">Test/Execute</button>
		</div>
		<div class="col-md-2"></div>
	</div>
	
	<!-- edit form -->
	<div class="row" id="calculation-step-edit-container" style="width: 100%; height: 100%; left:0">
		<div class="col-md-2">
		</div>
		<div class="col-md-8">
		
			<form id="step-form" class="form-horizontal" method="POST" action="rest/calculationstep/save.json">
				<input type="hidden" class="form-control" name="id" /> 
				<fieldset>

					<legend>Formula Editor</legend>
						
					<div class="form-group">
						<label class="col-md-2 control-label">Caption</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="caption">
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label">Entity</label>
						<div class="col-md-10">
							<select class="form-control" name="entityId"></select>
						</div>
					</div>
					<div class="form-group">
						<label for="select-variable" class="col-md-2 control-label">Variable</label>
						<div class="col-md-9">
							<select class="form-control" name="variableId" disabled="disabled"></select>
						</div>
<!-- 						<div class="no-padding col-md-1"> -->
							<button name="add-variable" type="button" class="calculation btn btn-info col-md-1" disabled="disabled">
								<i class="icon-plus-sign-alt"></i>
							</button>
<!-- 						</div> -->
					</div>
					<div class="form-group">
<!-- 						<div class="row"> -->
							<label class="col-md-2 control-label">Script</label>
							<div class="col-md-10">
								
								<!-- Formula editor -->
<!-- 								<div class="row small-text formula-editor"> -->
<!-- 									<div class="col-md-12"> -->
<!-- 										Input variables -->
<!-- 										<button name="add-input-variable" class="calculation btn btn-info"> -->
<!-- 											<i class="icon-plus-sign-alt"></i> -->
<!-- 										</button> -->
<!-- 									</div> -->
<!-- 									<div class="row input-vars"> -->
<!-- 									</div> -->
<!-- 								</div> -->
<!-- 								<div class="checkbox col-lg-10"> -->
<!-- 									<label> <input type="checkbox" name="external-formula"> Run as external process </label> -->
<!-- 								</div>								 -->
								<div class="row" style="margin-top: 5px;">
									<textarea class="form-control" rows="13" name="script"></textarea>
								</div>
							</div>
					</div>
					
					<div class="form-group buttons">
						<div class="col-md-2 col-md-offset-5" style="text-align: center;">
							<button type="submit" class="btn btn-default btn-lg" style="width: 100%">Save</button>
						</div>
<!-- 						<div class="col-md-6 step-edit-exec-option"> -->
<!-- 							<div class="col-md-6"> -->
<!-- 								<button type="button" name="run-calculcation-step" class="btn btn-default btn-lg" style="width: 50%">Execute</button> -->
<!-- 								<button type="button" name="exec-options" class="btn no-background options-btn"><i class="icon-cog"></i></button> -->
<!-- 							</div> -->
<!-- 							<div class="col-md-6 options"> -->
<!-- 								<input type="text" class="form-control no-border" name="totalItems" placeholder="Number of records"> -->
<!-- 							</div> -->
<!-- 						</div> -->
					</div>
					
					<!-- Old buttons to save and execute.  -->
<!-- 					<div class="form-group buttons"> -->
<!-- 						<div class="col-md-3 col-md-offset-3" style="text-align: center;"> -->
<!-- 							<button type="submit" class="btn btn-default btn-lg" style="width: 50%">Save</button> -->
<!-- 						</div> -->
<!-- 						<div class="col-md-6 step-edit-exec-option"> -->
<!-- 							<div class="col-md-6"> -->
<!-- 								<button type="button" name="run-calculcation-step" class="btn btn-default btn-lg" style="width: 50%">Execute</button> -->
<!-- 								<button type="button" name="exec-options" class="btn no-background options-btn"><i class="icon-cog"></i></button> -->
<!-- 							</div> -->
<!-- 							<div class="col-md-6 options"> -->
<!-- 								<input type="text" class="form-control no-border" name="totalItems" placeholder="Number of records"> -->
<!-- 							</div> -->
<!-- 						</div> -->
<!-- 					</div> -->
				</fieldset>
				
				<!-- // NOT USED NOW -->
				<!-- Input variable fields. //hidden by default -->
				<div class="row input-var">
					<div class="col-md-2">
						Name
					</div>
					<div class="col-md-2">
						<input type="text" class="form-control input-var-name" name="input-var-name" >
					</div>
					<div class="col-md-2">
						Variable
					</div>
					<div class="col-md-4">
						<select class="form-control input-var-id" name="input-var-id"></select>
					</div>
					<div class="col-md-2">
						<button name="delete-input-var" class="calculation btn btn-info">
							<i class="icon-minus-sign-alt"></i>
						</button>
					</div>
				</div>
				
				
			</form>
		</div>
		<div class="col-md-2">
		</div>
<!-- 		</div> -->
	</div>
	
	<!-- Execution and results  -->
	<div class="row" id="calculation-step-exec-container" style="width: 100%; height: 100%; padding-top:10px; ">
		<!-- step information section -->
		<div class="row header">
<!-- 			<div class="col-md-1 col-md-offset-3" style="text-align: right;"> -->
<!-- 				<button name="edit-step-button" class="calculation btn btn-info" ><i class="icon-edit"></i></button> -->
<!-- 			</div> -->
<!-- 			<div class="col-md-12 header"> -->
<!-- 				<legend></legend> -->
<!-- 			</div> -->
			
		</div>
		
		<!-- Test section to implement -->
		<div class="row test" >
			<!-- TODO implement. (old progress bar below) -->
			<!-- progress bar -->
			<div class="row progress-bar-section" >
				<div class="col-md-2 col-md-offset-4 step-progress" style="padding-top: 15px;">
					<div class="progress"> 
						<div class="progress-bar"></div>
					</div>
				</div>
				<div class="col-md-1" style="padding-top: 8px;">
					<div class="col-md-1 percent"></div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-2 col-md-offset-5" style="text-align: center;">
					<button type="button" class="btn btn-default btn-lg" name="test-btn" style="width: 100%">Test</button>
				</div>
			</div>
		</div>
		
		<div class="row exec" >
			<div class="col-md-2 col-md-offset-5" style="text-align: center;">
				<button type="button" class="btn btn-default btn-lg" name="exec-btn" style="width: 100%">Execute</button>
			</div>
		</div>
		
		<!-- results section -->
		<div class="row results" style="height: 70%; display: none">
			<div class="col-md-2">
			</div>
			<div class="col-md-8" id="calc-step-results" style="height: 100%">
			</div>
			<div class="col-md-2">
			</div>
		</div>
		
	</div>
	
	<!-- add variable popup form -->
	<div class="modal fade" id="add-variable-modal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-body">
					<form class="form-vertical" method="POST">
						<input type="hidden" class="form-control" name="entityId" /> 
						<fieldset>
							<div class="form-group" style="margin: 10px 4em 0px 4em">
								<label class="control-label">Name</label>
								<input type="text" class="form-control" name="name"></input>
							</div>
							<div class="row" style="margin-top: 25px">
								<div class="col-md-3 col-md-offset-3">
									<button type="button" class="btn btn-default save" style="width:100%">Save</button>
								</div>
								<div class="col-md-3">
									<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" style="width:100%">Cancel</button>
								</div>
							</div>					
						</fieldset>
					</form>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	
<script>
$(function(){
	//current calculation step
	var $calculationStep = null;
	
	//main ui component
	var stepEdit = $("#step-edit-page");
	
	/**
	 * ui components : edit, exec , results
	 */
	var $calculationStepEditContainer = stepEdit.find("#calculation-step-edit-container");
	var $calculationStepExecContainer = stepEdit.find("#calculation-step-exec-container");
	
	//TODO managers here. pass containers to managers and not form. add methods show and hide?
	/**
	* ui managers 
	*/
	var calculationStepEditManager = new CalculationStepEditManager($calculationStepEditContainer);	
	var calculationStepExecManager = new CalculationStepExecManager($calculationStepExecContainer);
	calculationStepExecManager.hide();
	
	//TODO check what to do with these managers
	var $resultsContainer = $("#calc-step-results");
	var dataManager = new DataManager($resultsContainer);
	var calculationStepManager = CalculationStepManager.getInstance();
	var workspaceManager = WorkspaceManager.getInstance();

	/**
	* Header buttons
	*/
	var showEditBtn = stepEdit.find("button[name=show-edit-btn]");
	var showExecBtn = stepEdit.find("button[name=show-exec-btn]");
	
	/**
	* Event handlers for header buttons
	*/
	/*
	*/
	showEditBtn.click(function(e){
		e.preventDefault();
		
// 		$calculationStepExecContainer.fadeOut(400);
		calculationStepExecManager.hide();
		$calculationStepEditContainer.fadeIn(400);
	});
	
	/**
	* Show exec section
	*/
	showExecBtn.click(function(e){
		e.preventDefault();
		if(calculationStepEditManager.currentCalculationStep){
			// first save the calculation step if it has changed
			calculationStepEditManager.saveIfChanged(function(response) {
				var calculationStep = response;
				$calculationStepEditContainer.hide();
				calculationStepExecManager.show(calculationStep);
			});
		} else {
			UI.showError("You must create a calculation step before trying to execute it", true);
		}
	});
	
	
	// TODO remove: exec options moved to test section
	//exec options ui components
	var execOptionsBtn = $calculationStepEditContainer.find(".step-edit-exec-option button[name=exec-options]");
	var execOptions = $calculationStepEditContainer.find(".step-edit-exec-option .options");
	var execOptionsWidth = -1;
	execOptions.hide();

	/**
	 * TODO move to result/exec? manager
	 * results ui components
	 */
	//div where the progress bar is stored
	$stepProgress = $(".step-progress"); 
	

	
	
	
	
	
	
	
	
	/*** 
	* ================= 
	* Run Calculation
	* =================
	*/
	// it has to be false the first time the script gets executed
	processResultsStarted = false;
	rowNum = 1;
	
	//DEPRECATED
	showResultsContainer = function() {
		// write step caption as header
		$calculationStepExecContainer.find(".step-name legend").html($calculationStep.caption);
		
		$calculationStepEditContainer.fadeOut(400);
		$calculationStepExecContainer.fadeIn(400);
	};
	
	resetResultsContainer = function() {
		//reset progress and results table
		$progressBar = $stepProgress.find(".progress-bar");		
		UI.resetProgressBar($progressBar);
		
		
// 		$resultsTable.find('thead').empty();
// 		$resultsTable.find('tbody').empty();
		
		//reset variables used for displaying the results
		processResultsStarted = false;
		rowNum = 1;
	};
	
	//DEPRECATED
	showEditFormContainer = function(){
		//reset progress and results table
		$progressBar = $stepProgress.find(".progress-bar");		
		UI.resetProgressBar($progressBar);
		
// 		$resultsTable.find('thead').empty();
// 		$resultsTable.find('tbody').empty();
		
		//reset variables used for displaying the results
		processResultsStarted = false;
		rowNum = 1;
		//resetResultsContainer();
		$calculationStepExecContainer.fadeOut(400);
		$calculationStepEditContainer.fadeIn(400);
	}; 
	
	
	// DEPRECATED
	//on run calcuclation button click	
	$stepForm.find("button[name='run-calculcation-step']").click(function(event){
		event.preventDefault();
		//first save the step and then it gets executed
		calculationStepEditManager.save(function(response) {
			
			$calculationStep = response;
			stepId = $calculationStep.id;
			
			var totalItems = parseInt( $stepForm.find("input[name='totalItems']").val() );
			calculationStepManager.execute(stepId, totalItems, function(response) {
				console.log("response on exec");
				console.log(response);
				var $job = response;
				updateCalculationStepStatus($job);
				showResultsContainer();
			});
		});
		
		// animation disabled for now
// 		$calculationStepEditContainer
//  			.animate({left: parseInt($calculationStepEditContainer.css('left'),10) == 0 ? -$calculationStepEditContainer.outerWidth() : 0 });
// 			;
// 		$calculationStepExecContainer
// 			.show(400)
// 			.animate({left:0}, 400)
// 			;
		
	});
	
	updateCalculationStepStatus = function($job) {

		//start processing results the first time the status != pending
		if(!processResultsStarted) {
			processResults($job);
		}
// 		//update data manager job
// 		dataManager.updateJob($job);
// 		console.log($job);
		var $task = $job.tasks[0];

		var $progressBar = $stepProgress.find(".progress-bar");		
		UI.resetProgressBar($progressBar);
		
		var totalItems = $task.totalItems;
		var itemsProcessed = $task.itemsProcessed;
		var percent = (totalItems > 0 ) ?  parseInt(itemsProcessed / totalItems * 100) : -1 ;
		
		switch( $task.status ) {
		case "PENDING":
			//refresh job
			refreshJob($job);
			break;
		case "RUNNING": 
			$progressBar.addClass("progress-bar-info");
			if( percent >= 0 ) { 
				$progressBar.width(percent+"%");
			} else {
				$progressBar.parent().addClass("active progress-striped");
				$progressBar.width("100%");
			}
			var htmlPercent = (percent >= 0) ? percent + " %" : " -% ";
			$calculationStepExecContainer.find(".percent").text(htmlPercent);
			
			//update data manager job
			dataManager.updateJob($job);
			
			//if job not completed, it gets reloaded from server
// 			if( $job.completed != true ) {
			// refresh job
			refreshJob($job);
// 			setTimeout(function(){
// 				//var stepId = $calculationStep.id;
// 				$.ajax({
// 					url:"rest/job/"+$job.id+".json",
// 					dataType:"json"
// 				})
// 				.done(function(response){
// 					var job = response;
// 					updateCalculationStepStatus(job);
// 				});
// 			}, 500);
// 			}
			break;
		case "COMPLETED": 
			$progressBar.addClass("progress-bar-success");
			$progressBar.width("100%");
			$calculationStepExecContainer.find(".percent").text("100%");
			
			//update data manager job
			dataManager.updateJob($job);
			break;
		case "FAILED":
// 			console.log($job);
			UI.showError($job.lastException.message, false);
// 			UI.Form.showResultMessage($job.lastException.message, false);
			break;
			
		default: // nothing for now;
		}
		
	};
	
	var refreshJob = function($job){
		setTimeout(function(){
			//var stepId = $calculationStep.id;
			$.ajax({
				url:"rest/job/"+$job.id+".json",
				dataType:"json"
			})
			.done(function(response){
				var job = response;
				updateCalculationStepStatus(job);
			});
		}, 500);
	};
	
	var processResults = function($job) {
		if(processResultsStarted != true) {
			if( $job.status != 'PENDING' && $job.status != "FAILED" ) {

				dataManager.showJobResults($job);
				processResultsStarted = true;

			}
			
		}
	};
	
	//TODO to be removed
	//exec options click
	execOptionsBtn.click(function(e){
		if(execOptionsWidth < 0){
			execOptionsWidth = execOptions.width();
		}
		
		//only shows for now
		if(execOptions.is(":visible")) {
// 			execOptions.animate({width:'0px'}, 200,'easeInOutExpo');
// 			execOptions.fadeOut(100);
// 			setTimeout(function(){execOptions.hide()}, 500);
		} else {
			execOptions.css({width:"0px"});
			execOptions.show();
			execOptions.animate({width:execOptionsWidth+'px'}, 600,'easeOutExpo');
		}
	});
	
	
	
	
	
	
	
	// ============================== Input variable code. not used now, but left here now for convenience 
	
	/**
	* Input variables. not used now
	*/ 
	$inputVars = $(".input-vars");
	$inputVar = $(".input-var");
	$inputVar.hide();

	
	/**
	* Input variable. not used now
	*/
	// add input variable to the form
	$stepForm.find("button[name='add-input-variable']").click(function(event){
		event.preventDefault();
	
		$var = $inputVar.clone();
		$inputVars.append($var);
		//bind delete button click			
		$var.find("[name='delete-input-var']").click(deleteInputVariable);
		//remove selection of variable from select
		select = $var.find(".input-var-id");
		select.val([]);
		// input-var-name,  input-var
		renameInputVariables();
		$var.fadeIn();
		
	});
	renameInputVariables = function() {
		vars = $inputVars.find('.input-var');
		$.each(vars, function(i, div) {
			$varId = $(div).find('.input-var-name');
			$varName = $(div).find('.input-var-id');
			
			$varId.attr('name','input-var-id-'+i);
			$varName.attr('name','input-var-name-'+i);
		});
	};
	deleteInputVariable = function(event){
		event.preventDefault();
		$var = $(this).parents('.input-var');
		$var.fadeOut(200);
		setTimeout(function(){
			
			$var.remove();
			renameInputVariables();
		}, 300);
	};
	
});
</script>
</div>
