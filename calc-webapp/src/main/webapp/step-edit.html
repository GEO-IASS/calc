<!-- ==== Html here === -->
<div class="page-section">
	<div class="row" id="calculation-step-edit-container" style="position: fixed; width: 100%; height: 100%; overflow: auto; left:0">
		<div class="col-md-2">
		</div>
		<div class="col-md-8">
		
<!-- 		<div class="well"> -->
			<form id="step-form" class="form-horizontal" method="POST" action="rest/calculationstep/save.json">
				<input type="hidden" class="form-control" name="id" /> 
				<fieldset>

					<legend>Calculation Step Editor </legend>
						
					<div class="form-group">
						<label class="col-md-2 control-label">Name</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="caption">
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label">Entity</label>
						<div class="col-md-10">
							<select class="form-control" name="entityId"></select>
						</div>
					</div>
					<div class="form-group">
						<label for="select-variable" class="col-md-2 control-label">Output Variable</label>
						<div class="col-md-9">
							<select class="form-control" name="variableId" disabled="disabled"></select>
						</div>
<!-- 						<div class="no-padding col-md-1"> -->
							<button name="add-variable" class="calculation btn btn-info col-md-1">
								<i class="icon-plus-sign-alt"></i>
							</button>
<!-- 						</div> -->
					</div>
					<div class="form-group">
<!-- 						<div class="row"> -->
							<label class="col-md-2 control-label">Script</label>
							<div class="col-md-10">
								
								<!-- Formula editor -->
<!-- 								<div class="row small-text formula-editor"> -->
<!-- 									<div class="col-md-12"> -->
<!-- 										Input variables -->
<!-- 										<button name="add-input-variable" class="calculation btn btn-info"> -->
<!-- 											<i class="icon-plus-sign-alt"></i> -->
<!-- 										</button> -->
<!-- 									</div> -->
<!-- 									<div class="row input-vars"> -->
<!-- 									</div> -->
<!-- 								</div> -->
<!-- 								<div class="checkbox col-lg-10"> -->
<!-- 									<label> <input type="checkbox" name="external-formula"> Run as external process </label> -->
<!-- 								</div>								 -->
								<div class="row" style="margin-top: 5px;">
									<textarea class="form-control" rows="13" name="script"></textarea>
								</div>
							</div>
					</div>
					
					<div class="form-group buttons">
						<div class="col-md-3 col-md-offset-3" style="text-align: center;">
							<button type="submit" class="btn btn-default btn-lg" style="width: 50%">Save</button>
						</div>
						<div class="col-md-3" style="text-align: center;">
							<button type="button" name="run-calculcation-step" class="btn btn-default btn-lg" style="width: 50%">Run</button>
						</div>
<!-- 						<div class="col-lg-2"> -->
<!-- 							<button class="btn btn-default cancel btn-lg">Cancel</button> -->
<!-- 						</div> -->
					</div>
				</fieldset>
				
				<!-- Input variable fields. //hidden by default -->
				<div class="row input-var">
					<div class="col-md-2">
						Name
					</div>
					<div class="col-md-2">
						<input type="text" class="form-control input-var-name" name="input-var-name" >
					</div>
					<div class="col-md-2">
						Variable
					</div>
					<div class="col-md-4">
						<select class="form-control input-var-id" name="input-var-id"></select>
					</div>
					<div class="col-md-2">
						<button name="delete-input-var" class="calculation btn btn-info">
							<i class="icon-minus-sign-alt"></i>
						</button>
					</div>
				</div>
			</form>
		</div>
		<div class="col-md-2">
		</div>
<!-- 		</div> -->

		
	</div>
	<div class="row" id="calculation-step-exec-container" style="position: fixed; width: 100%; height: 100%; overflow: auto;">
			<div class="col-md-2">
			</div>
			<div class="col-md-8">
				ciaao!
			</div>
			<div class="col-md-2">
			</div>
		</div>
	
	<!-- New variable popup -->
	<div class="modal fade" id="new-variable-modal">
		<div class="modal-dialog">
			<div class="modal-content">
<!-- 				<div class="modal-header"> -->
<!-- 					<h4 class="modal-title">New Attribute</h4> -->
<!-- 				</div> -->
				<div class="modal-body">
					<form class="form-vertical" method="POST" action="rest/workspace/variable/save.json">
						<fieldset>
							<div class="form-group">
								<label class="col-md-2 control-label">Variable name</label>
								<div class="col-md-10">
									<input type="text" class="form-control" name="name"></input>
								</div>
							</div>
						</fieldset>
					</form>
				</div>
				<div class="modal-footer">
					<div class="col-md-3">
						<button type="submit" class="btn btn-default save">Save</button>
					</div>
					<div class="col-md-3">
						<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">Cancel</button>
					</div>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	
<script>
$(function(){
	$calculationStep = null;
	$calculationStepEditContainer = $("#calculation-step-edit-container");
	$calculationStepExecContainer = $("#calculation-step-exec-container");
	
	$stepForm = $('#step-form');
	$entitySelect = $stepForm.find("[name='entityId']");
	$variableSelect = $stepForm.find("[name='variableId']");
	
	$inputVars = $(".input-vars");
	$inputVar = $(".input-var");
	
	$calculationStepExecContainer.hide();
// 	$calculationStepExecContainer.css({left:$(document).width()})
// 	$inputVars.hide();
	$inputVar.hide();
	
	//load entities into select
	loadEntities = function(callback) {
		$entitySelect.empty();
		$variableSelect.attr("disabled", "disabled");
		$variableSelect.empty();
		
		$.ajax({
			url: "rest/workspace/entities.json",
			dataType: "json"
		})
		.done(function(response) {
			var entities = response;
			$.each(entities, function(i, entity) {
				 $entitySelect.append($("<option />").val(entity.id).text(entity.name));
			});
			$entitySelect.val([]);
			if(callback){
				callback();
			}
		}); 
	};
	//load variables into select
	loadVariables = function(callback) {
		$variableSelect.attr("disabled", "disabled");
		$variableSelect.empty();
		
		$inputVarSelects = $stepForm.find(".input-var-id");
		$inputVarSelects.empty();
		
		$selectedEntity = $entitySelect.find(":selected");
		if ( $selectedEntity != null ) {
			$.ajax({
				url: "rest/workspace/entities/" + $selectedEntity.val() + "/variables.json",
				dataType: "json"
			})
			.done(function(response) {				
				variables = response;
				
				$.each(variables, function(i, variable) {
					
					$option = $("<option />").val(variable.id).text(variable.name);
					
					$variableSelect.append($option);
					
					//update each input variable select
					$.each($inputVarSelects, function(i,select){
						$(select).append($option.clone());
						$(select).val([]);
					});
					 
				});
				$variableSelect.removeAttr("disabled");
				$variableSelect.val([]);
				if ( callback ) {
					callback();
				}
			}); 
		}
	};
	// save the calculation step 
	saveStep = function(succesCallback) {
		$stepForm.ajaxForm( {
		    dataType : 'json',
		    beforeSubmit: function() {
		        CalcForm.disableForm( $stepForm );
		    },
		    success: function ( response ) {
		    	CalcForm.updateErrors($stepForm, response.errors);
		    	if(response.status == "ERROR" ) {
		    		CalcForm.showResultMessage("There are errors in the form. Please fix them before proceeding.",false);
		    	} else {
		    		CalcForm.showResultMessage("Calculation step successfully saved.",true);
		    		
		    		$calculationStep = response.fields.calculationStep;
		    		updateCalculationStepUi($calculationStep);
		    		console.log($calculationStep);
		    		console.log(response);
			    	if(succesCallback){
			    		succesCallback(response)
		    		};
		    	}
		    	CalcForm.enableForm( $stepForm );
		    },
		    error: function (e) {
		    	CalcForm.showResultMessage("An error occured. Please check the log file.",false );
		    	CalcForm.enableForm( $stepForm );
		    }
		});	
		
		$stepForm.submit();
	}

	// on submit button click 
	$stepForm.find("button[type='submit']").click(function(event){
		event.preventDefault();
		saveStep();
	});
	
	// opens the New Variable popup
	$stepForm.find("button[name='add-variable']").click(function(event){
		event.preventDefault();
		var $modal = $('#new-variable-modal').modal({keyboard:false,backdrop:"static"});
		var $form = $modal.find('form');
		CalcForm.reset($form);
		
		$form.ajaxForm( {
		    dataType : 'json',
		    data: {
		    	entityId: $entitySelect.val()
		    },
		    beforeSubmit: function() {
		        CalcForm.disableForm( $form );
		    },
		    success: function ( response ) {
		    	CalcForm.enableForm( $form );
		    	CalcForm.updateErrors($form, response.errors);
		    	if(response.status == "ERROR" ) {
		    		CalcForm.showResultMessage("Error, invalid data",false);
		    	} else {
		    		var variable = response.fields.variable;
		    		loadVariables(function() {
		    			$variableSelect.val(variable.id);
		    		});
		    		$modal.modal('hide');
		    	}
		    },
		    error: function (e) {
		    	CalcForm.enableForm( $form );
		    }
		});
		
		$modal.find('button.save').click(function() {
			$form.submit();
		});
	});
	
	// add input variable to the form
	$stepForm.find("button[name='add-input-variable']").click(function(event){
		event.preventDefault();
	
		$var = $inputVar.clone();
		$inputVars.append($var);
		//bind delete button click			
		$var.find("[name='delete-input-var']").click(deleteInputVariable);
		//remove selection of variable from select
		select = $var.find(".input-var-id");
		select.val([]);
		// input-var-name,  input-var
		renameInputVariables();
		$var.fadeIn();
		
	});
	
	renameInputVariables = function() {
		vars = $inputVars.find('.input-var');
		$.each(vars, function(i, div) {
			$varId = $(div).find('.input-var-name');
			$varName = $(div).find('.input-var-id');
			
			$varId.attr('name','input-var-id-'+i);
			$varName.attr('name','input-var-name-'+i);
		});
	};
	
	deleteInputVariable = function(event){
		event.preventDefault();
		$var = $(this).parents('.input-var');
		$var.fadeOut(200);
		setTimeout(function(){
			
			$var.remove();
			renameInputVariables();
		}, 300);
	};
	
	$entitySelect.change(function(event) {
		loadVariables();
	});

	//on run calcuclation button click	
	$stepForm.find("button[name='run-calculcation-step']").click(function(event){
		event.preventDefault();
		//first save the step and then it runs
		saveStep(
			function(response){
				//after saving it, it get started
				stepId = $calculationStep.id;
				$.ajax({
					url:"rest/calculationstep/"+stepId+"/run.json",
					dataType:"json"
				})
				.done(function(response){
					$job = response;
					console.log($job);
					$calculationStepEditContainer.fadeOut(400);
					$calculationStepExecContainer.fadeIn(400);
				});
				
				
			}		
		);
		
		// animation disabled for now
// 		$calculationStepEditContainer
//  			.animate({left: parseInt($calculationStepEditContainer.css('left'),10) == 0 ? -$calculationStepEditContainer.outerWidth() : 0 });
// 			;
// 		$calculationStepExecContainer
// 			.show(400)
// 			.animate({left:0}, 400)
// 			;
		
	});
	
	//load calculation step with given stepId
	loadCalculationStep = function(stepId) {
		$.ajax({
			url:"rest/calculationstep/"+stepId+"/load.json",
			dataType:"json"
		})
		.done(function(response){
			$step = response;
			updateCalculationStepUi($step);
		});
	};
	
	updateCalculationStepUi = function($step) {
		$entitySelect.val($step.outputEntityId);
		
		loadVariables(function() {
			$variableSelect.val($step.outputVariableId);
			
			CalcForm.setFieldValues($stepForm, $step);
		});
	};
	
	init = function(){
		loadEntities(
			function(){
				url = this.target;
				stepId = $.url(url).param("id");
				if(stepId) {
					loadCalculationStep(stepId);
				}
			}		
		);
	};
	// on load
	init();
	
});
</script>
</div>
