<!-- ==== Html here === -->
<div class="page-section">
	<div class="row">
		<div class="col-md-2">
		</div>
		<div class="col-md-8">
		
<!-- 		<div class="well"> -->
			<form id="step-form" class="form-horizontal" method="POST" action="rest/calculationstep/save.json">
				<fieldset>
					<legend>Calculation Step Editor</legend>
					<div class="form-group">
						<label class="col-md-2 control-label">Name</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="name">
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label">Entity</label>
						<div class="col-md-10">
							<select class="form-control" name="entity"></select>
						</div>
					</div>
					<div class="form-group">
						<label for="select-variable" class="col-md-2 control-label">Output Variable</label>
						<div class="col-md-9">
							<select class="form-control" name="variable" disabled="disabled"></select>
						</div>
<!-- 						<div class="no-padding col-md-1"> -->
							<button name="add-variable" class="calculation btn btn-info col-md-1">
								<i class="icon-plus-sign-alt"></i>
							</button>
<!-- 						</div> -->
					</div>
					<div class="form-group">
<!-- 						<div class="row"> -->
							<label class="col-md-2 control-label">Formula</label>
							<div class="col-md-10">
								
								<!-- Formula editor -->
								<div class="row small-text formula-editor">
									<div class="col-md-12">
										Input variables
										<button name="add-input-variable" class="calculation btn btn-info">
											<i class="icon-plus-sign-alt"></i>
										</button>
									</div>
									<div class="row input-vars">
									</div>
								</div>
								
								<div class="row" style="margin-top: 5px;">
									<textarea class="form-control" rows="13" name="formula"></textarea>
								</div>
<!-- 										<span class="help-block">A longer block of help text -->
<!-- 											that breaks onto a new line and may extend beyond one line.</span> -->
							</div>
							
<!-- 							<div class="checkbox col-lg-10"> -->
<!-- 								<label> <input type="checkbox" name="external-formula"> Run as external process </label> -->
<!-- 							</div> -->




<!-- 							<label for="external-formula" class="col-lg-2 control-label">Run as external process</label> -->
<!-- 							<div class="col-lg-10"> -->
<!-- 								<input type="checkbox" name="external-formula" /> -->
<!-- 							</div> -->
<!-- 						</div> -->
<!-- 						<div class="col-lg-2"> -->
<!-- 							<div class="radio"> -->
<!-- 								<label><input type="radio" name="type" value="formula" /> Formula</label> -->
<!-- 							</div> -->
<!-- 						</div> -->
<!-- 						<div class="col-lg-2"> -->
<!-- 							<div class="radio">								 -->
<!-- 								<label><input type="radio" name="type" value="r" /> R</label> -->
<!-- 							</div>	 -->
<!-- 						</div> -->
<!-- 						<div class="col-lg-2"> -->
<!-- 							<div class="radio">								 -->
<!-- 								<label><input type="radio" name="type" value="sql" /> SQL</label> -->
<!-- 							</div> -->
<!-- 						</div> -->
<!-- 						<div class="col-lg-4"></div> -->
						
					</div>
					<div class="form-group buttons">
						<div class="col-md-12" style="text-align: center;">
							<button type="submit" class="btn btn-default btn-lg">Save</button>
						</div>
<!-- 						<div class="col-lg-2"> -->
<!-- 							<button class="btn btn-default cancel btn-lg">Cancel</button> -->
<!-- 						</div> -->
					</div>
				</fieldset>
				
				<!-- Input variable fields. //hidden by default -->
				<div class="row input-var">
					<div class="col-md-2">
						Name
					</div>
					<div class="col-md-2">
						<input type="text" class="form-control input-var-name" name="input-var-name" >
					</div>
					<div class="col-md-2">
						Variable
					</div>
					<div class="col-md-4">
						<select class="form-control input-var-id" name="input-var-id"></select>
					</div>
					<div class="col-md-2">
						<button name="delete-input-var" class="calculation btn btn-info">
							<i class="icon-minus-sign-alt"></i>
						</button>
					</div>
				</div>
			</form>
		</div>
		<div class="col-md-2">
		</div>
<!-- 		</div> -->


	</div>
	
<script>
$(function(){
	$stepForm = $('#step-form');
	$entitySelect = $stepForm.find("[name='entity']");
	$variableSelect = $stepForm.find("[name='variable']");
	
	$inputVars = $(".input-vars");
	$inputVar = $(".input-var");
	
	
// 	$inputVars.hide();
	$inputVar.hide();
	
	updateEntities = function() {
		$entitySelect.empty();
		$variableSelect.attr("disabled", "disabled");
		$variableSelect.empty();
		
		$.ajax({
			url: "rest/workspace/entities.json",
			dataType: "json"
		})
		.done(function(response) {
			var entities = response;
			$.each(entities, function(i, entity) {
				 $entitySelect.append($("<option />").val(entity.id).text(entity.name));
			});
			//updateVariables();
			$entitySelect.val([]);
		}); 
	};
	
	updateVariables = function() {
		$variableSelect.attr("disabled", "disabled");
		$variableSelect.empty();
		
		$inputVarSelects = $stepForm.find(".input-var-id");
		$inputVarSelects.empty();
		
		$selectedEntity = $entitySelect.find(":selected");
		if ( $selectedEntity != null ) {
			$.ajax({
				url: "rest/workspace/entities/" + $selectedEntity.val() + "/variables.json",
				dataType: "json"
			})
			.done(function(response) {				
				variables = response;
				
				$.each(variables, function(i, variable) {
					
					$option = $("<option />").val(variable.id).text(variable.name);
					
					$variableSelect.append($option);
					
					//update each input variable select
					$.each($inputVarSelects, function(i,select){
						$(select).append($option.clone());
						$(select).val([]);
					});
					 
				});
				$variableSelect.removeAttr("disabled");
				$variableSelect.val([]);
			}); 
		}
	};
	
	$stepForm.ajaxForm( {
	    dataType : 'json',
	    beforeSubmit: function() {
	        $(this).addClass('loading');
	    },
	    success: function ( response ) {
// 	    	console.log(response);
	    	CalcForm.updateErrors($stepForm, response.errors);
	    },
	    error: function (e) {
	    	alert('Error submitting form');
	    }
	});
	
	$stepForm.find("button[type='submit']").click(function(event){
		event.preventDefault();
		$stepForm.submit();
	});
	
	$stepForm.find("button[name='add-variable']").click(function(event){
		event.preventDefault();
	});
	
	
	// add input variable to the form
	$stepForm.find("button[name='add-input-variable']").click(function(event){
		event.preventDefault();
	
		$var = $inputVar.clone();
		$inputVars.append($var);
					
		$var.find("[name='delete-input-var']").click(deleteInputVariable);
		//select = $inputVar.find("[name='input-var']");
		// input-var-name,  input-var
		renameInputVariables();
		$var.fadeIn();
		
	});
	
	renameInputVariables = function() {
		vars = $inputVars.find('.input-var');
		$.each(vars, function(i, div) {
			$varId = $(div).find('.input-var-name');
			$varName = $(div).find('.input-var-id');
			
			$varId.attr('name','input-var-id-'+i);
			$varName.attr('name','input-var-name-'+i);
			
// 			console.log($varId.attr('name'));
// 			console.log($varName.attr('name'));
		});
	}; 
	
	deleteInputVariable = function(event){
		event.preventDefault();
		$var = $(this).parents('.input-var');
		$var.fadeOut(200);
		setTimeout(function(){
			
			$var.remove();
			renameInputVariables();
		}, 300);
// 		console.log($var);
	};
	
	$entitySelect.change(function(event) {
		updateVariables();
	});
	
	
	updateEntities();
	
});
</script>
</div>