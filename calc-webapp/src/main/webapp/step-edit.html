<!-- ==== Html here === -->
<div class="page-section">
	<div class="row" id="calculation-step-edit-container">
		<div class="col-md-2">
		</div>
		<div class="col-md-8">
		
<!-- 		<div class="well"> -->
			<form id="step-form" class="form-horizontal" method="POST" action="rest/calculationstep/save.json">
				<fieldset>

					<legend>Calculation Step Editor </legend>
						
					<div class="form-group">
						<label class="col-md-2 control-label">Name</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="name">
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label">Entity</label>
						<div class="col-md-10">
							<select class="form-control" name="entityId"></select>
						</div>
					</div>
					<div class="form-group">
						<label for="select-variable" class="col-md-2 control-label">Output Variable</label>
						<div class="col-md-9">
							<select class="form-control" name="variableId" disabled="disabled"></select>
						</div>
<!-- 						<div class="no-padding col-md-1"> -->
							<button name="add-variable" class="calculation btn btn-info col-md-1">
								<i class="icon-plus-sign-alt"></i>
							</button>
<!-- 						</div> -->
					</div>
					<div class="form-group">
<!-- 						<div class="row"> -->
							<label class="col-md-2 control-label">Script</label>
							<div class="col-md-10">
								
								<!-- Formula editor -->
<!-- 								<div class="row small-text formula-editor"> -->
<!-- 									<div class="col-md-12"> -->
<!-- 										Input variables -->
<!-- 										<button name="add-input-variable" class="calculation btn btn-info"> -->
<!-- 											<i class="icon-plus-sign-alt"></i> -->
<!-- 										</button> -->
<!-- 									</div> -->
<!-- 									<div class="row input-vars"> -->
<!-- 									</div> -->
<!-- 								</div> -->
<!-- 								<div class="checkbox col-lg-10"> -->
<!-- 									<label> <input type="checkbox" name="external-formula"> Run as external process </label> -->
<!-- 								</div>								 -->
								<div class="row" style="margin-top: 5px;">
									<textarea class="form-control" rows="13" name="script"></textarea>
								</div>
							</div>
					</div>
					
					<div class="form-group buttons">
						<div class="col-md-3 col-md-offset-3" style="text-align: center;">
							<button type="submit" class="btn btn-default btn-lg" style="width: 50%">Save</button>
						</div>
						<div class="col-md-3" style="text-align: center;">
							<button type="button" name="run-calculcation-step" class="btn btn-default btn-lg" style="width: 50%">Run</button>
						</div>
<!-- 						<div class="col-lg-2"> -->
<!-- 							<button class="btn btn-default cancel btn-lg">Cancel</button> -->
<!-- 						</div> -->
					</div>
				</fieldset>
				
				<!-- Input variable fields. //hidden by default -->
				<div class="row input-var">
					<div class="col-md-2">
						Name
					</div>
					<div class="col-md-2">
						<input type="text" class="form-control input-var-name" name="input-var-name" >
					</div>
					<div class="col-md-2">
						Variable
					</div>
					<div class="col-md-4">
						<select class="form-control input-var-id" name="input-var-id"></select>
					</div>
					<div class="col-md-2">
						<button name="delete-input-var" class="calculation btn btn-info">
							<i class="icon-minus-sign-alt"></i>
						</button>
					</div>
				</div>
			</form>
		</div>
		<div class="col-md-2">
		</div>
<!-- 		</div> -->

		
	</div>
	<div class="row" id="calculation-step-exec-container" style="height: 0px">
			<div class="col-md-2">
			</div>
			<div class="col-md-8">
				ciaao!
			</div>
			<div class="col-md-2">
			</div>
		</div>
<script>
$(function(){
	$calculationStepEditContainer = $("#calculation-step-edit-container");
	$calculationStepExecContainer = $("#calculation-step-exec-container");
	
	$stepForm = $('#step-form');
	$entitySelect = $stepForm.find("[name='entityId']");
	$variableSelect = $stepForm.find("[name='variableId']");
	
	$inputVars = $(".input-vars");
	$inputVar = $(".input-var");
	
	$calculationStepExecContainer.hide();
// 	$inputVars.hide();
	$inputVar.hide();
	
	//load entities into select
	updateEntities = function() {
		$entitySelect.empty();
		$variableSelect.attr("disabled", "disabled");
		$variableSelect.empty();
		
		$.ajax({
			url: "rest/workspace/entities.json",
			dataType: "json"
		})
		.done(function(response) {
			var entities = response;
			$.each(entities, function(i, entity) {
				 $entitySelect.append($("<option />").val(entity.id).text(entity.name));
			});
			//updateVariables();
			$entitySelect.val([]);
		}); 
	};
	//load variables into select
	updateVariables = function() {
		$variableSelect.attr("disabled", "disabled");
		$variableSelect.empty();
		
		$inputVarSelects = $stepForm.find(".input-var-id");
		$inputVarSelects.empty();
		
		$selectedEntity = $entitySelect.find(":selected");
		if ( $selectedEntity != null ) {
			$.ajax({
				url: "rest/workspace/entities/" + $selectedEntity.val() + "/variables.json",
				dataType: "json"
			})
			.done(function(response) {				
				variables = response;
				
				$.each(variables, function(i, variable) {
					
					$option = $("<option />").val(variable.id).text(variable.name);
					
					$variableSelect.append($option);
					
					//update each input variable select
					$.each($inputVarSelects, function(i,select){
						$(select).append($option.clone());
						$(select).val([]);
					});
					 
				});
				$variableSelect.removeAttr("disabled");
				$variableSelect.val([]);
			}); 
		}
	};
	//on save form submit
	$stepForm.ajaxForm( {
	    dataType : 'json',
	    beforeSubmit: function() {
	        $(this).addClass('loading');
	        CalcForm.disableForm( $stepForm );
	    },
	    
	    success: function ( response ) {
// 	    	console.log(response);
	    	CalcForm.updateErrors($stepForm, response.errors);
	    	if( response.errors.length == 0 ){
	    		CalcForm.showResultMessage("Success, the data was processed correctly",true);
	    	}else{
	    		CalcForm.showResultMessage("Error, invalid data",false);
	    	}
	    	
	    	CalcForm.enableForm( $stepForm );
	    },
	    error: function (e) {
	    	CalcForm.showResultMessage("Error submitting the form",false );
	    	CalcForm.enableForm( $stepForm );
	    }
	});
	
	// on submit button click 
	$stepForm.find("button[type='submit']").click(function(event){
		event.preventDefault();
		$stepForm.submit();
	});
	
	$stepForm.find("button[name='add-variable']").click(function(event){
		event.preventDefault();
	});
	
	// add input variable to the form
	$stepForm.find("button[name='add-input-variable']").click(function(event){
		event.preventDefault();
	
		$var = $inputVar.clone();
		$inputVars.append($var);
		//bind delete button click			
		$var.find("[name='delete-input-var']").click(deleteInputVariable);
		//remove selection of variable from select
		select = $var.find(".input-var-id");
		select.val([]);
		// input-var-name,  input-var
		renameInputVariables();
		$var.fadeIn();
		
	});
	
	renameInputVariables = function() {
		vars = $inputVars.find('.input-var');
		$.each(vars, function(i, div) {
			$varId = $(div).find('.input-var-name');
			$varName = $(div).find('.input-var-id');
			
			$varId.attr('name','input-var-id-'+i);
			$varName.attr('name','input-var-name-'+i);
		});
	};
	
	deleteInputVariable = function(event){
		event.preventDefault();
		$var = $(this).parents('.input-var');
		$var.fadeOut(200);
		setTimeout(function(){
			
			$var.remove();
			renameInputVariables();
		}, 300);
	};
	
	$entitySelect.change(function(event) {
		updateVariables();
	});
	

	//on run calcuclation button click	
	$stepForm.find("button[name='run-calculcation-step']").click(function(event){
		event.preventDefault();
		var left = $calculationStepEditContainer.offset().left;
// 		console.log($calculationStepEditContainer.offset());
// 		$homeSection.animate({left:"-="+$(document).width()}, 1000,'easeInOutExpo');
// 		$calculationStepEditContainer
// 			.css({left:left})
// 			.animate({left:"-="+$(document).width()}, 1000,'easeInOutExpo')
// 			;
// 		console.log($calculationStepEditContainer.offset());

// 		$calculationStepEditContainer
// 			.parent().css('overflow','hidden')
// 			.animate({width:'0px'}, 700)
// 			.hide(700)
// 			;
// 		$calculationStepExecContainer
// 			.show()
// 			.animate({height:$calculationStepExecContainer.parent().height}, 700)
// 			;
	});
	
	// on load 
	updateEntities();
	
});
</script>
</div>